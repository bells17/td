"use strict";

const fs = require("fs");
const co = require("co");
const mime = require("mime");
const csvParse = require("csv-parse/lib/sync");
const csvStringify = require("csv-stringify");

const transformToCSV = (parsed, delimiter) => {
  return new Promise((resolve, reject) => {
    csvStringify(parsed, { header: true, delimiter: delimiter }, (err, csv) => {
      if (err) {
        return reject(err);
      }
      resolve(csv);
    });
  });
};

const transform = (parsed, format) => {
  return co(function* () {
    switch (format) {
      case "json":
        return JSON.stringify(parsed);
      case "tsv":
        return yield transformToCSV(parsed, "\t");
      case "csv":
      default:
        return yield transformToCSV(parsed, ",");
    }
  });
};

const tdf = (data, options, isFile) => {
  return new Promise((resolve, reject) => {
    co(function* () {
      if (isFile) {
        const file = fs.readFileSync(data, "UTF8");
        switch (mime.lookup(data)) {
          case "application/json":
            try {
              const parsed = JSON.parse(file);
              const transformed = yield transform(parsed, options.output);
              return resolve(transformed);
            } catch (err) {
              return reject(err);
            }
          case "text/csv":
            try {
              const parsed = csvParse(file, {
                columns: true,
                trim: true,
                quote: options.quote || '"',
                delimiter: options.delimiter || ","
              });
              const transformed = yield transform(parsed, options.output || "json");
              return resolve(transformed);
            } catch (err) {
              return reject(err);
            }
          case "text/tab-separated-values":
            try {
              const parsed = csvParse(file, {
                columns: true,
                trim: true,
                quote: options.quote || '"',
                delimiter: options.delimiter || "\t"
              });
              const transformed = yield transform(parsed, options.output || "json");
              return resolve(transformed);
            } catch (err) {
              return reject(err);
            }
        }
      } else {
        switch (options.format) {
          case "json":
            try {
              const parsed = JSON.parse(data);
              const transformed = yield transform(parsed, options.output);
              return resolve(transformed);
            } catch (err) {
              return reject(err);
            }
          case "tsv":
            try {
              const parsed = csvParse(data, {
                columns: true,
                trim: true,
                quote: options.quote || '"',
                delimiter: options.delimiter || "\t"
              });
              const transformed = yield transform(parsed, options.output || "json");
              return resolve(transformed);
            } catch (err) {
              return reject(err);
            }
          case "csv":
          default:
            try {
              const parsed = csvParse(data, {
                columns: true,
                trim: true,
                quote: options.quote || '"',
                delimiter: options.delimiter || ","
              });
              const transformed = yield transform(parsed, options.output || "json");
              return resolve(transformed);
            } catch (err) {
              return reject(err);
            }
        }
      }
    });
  });
};

module.exports = tdf;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJjbyIsIm1pbWUiLCJjc3ZQYXJzZSIsImNzdlN0cmluZ2lmeSIsInRyYW5zZm9ybVRvQ1NWIiwicGFyc2VkIiwiZGVsaW1pdGVyIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJoZWFkZXIiLCJlcnIiLCJjc3YiLCJ0cmFuc2Zvcm0iLCJmb3JtYXQiLCJKU09OIiwic3RyaW5naWZ5IiwidGRmIiwiZGF0YSIsIm9wdGlvbnMiLCJpc0ZpbGUiLCJmaWxlIiwicmVhZEZpbGVTeW5jIiwibG9va3VwIiwicGFyc2UiLCJ0cmFuc2Zvcm1lZCIsIm91dHB1dCIsImNvbHVtbnMiLCJ0cmltIiwicXVvdGUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxLQUFLQyxRQUFRLElBQVIsQ0FBWDtBQUNBLE1BQU1DLEtBQUtELFFBQVEsSUFBUixDQUFYO0FBQ0EsTUFBTUUsT0FBT0YsUUFBUSxNQUFSLENBQWI7QUFDQSxNQUFNRyxXQUFXSCxRQUFRLG9CQUFSLENBQWpCO0FBQ0EsTUFBTUksZUFBZUosUUFBUSxlQUFSLENBQXJCOztBQUVBLE1BQU1LLGlCQUFpQixDQUFDQyxNQUFELEVBQVNDLFNBQVQsS0FBdUI7QUFDNUMsU0FBTyxJQUFJQyxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RDTixpQkFBYUUsTUFBYixFQUFxQixFQUFFSyxRQUFRLElBQVYsRUFBZ0JKLFdBQVdBLFNBQTNCLEVBQXJCLEVBQTZELENBQUNLLEdBQUQsRUFBTUMsR0FBTixLQUFjO0FBQ3pFLFVBQUlELEdBQUosRUFBUztBQUNQLGVBQU9GLE9BQU9FLEdBQVAsQ0FBUDtBQUNEO0FBQ0RILGNBQVFJLEdBQVI7QUFDRCxLQUxEO0FBTUQsR0FQTSxDQUFQO0FBUUQsQ0FURDs7QUFXQSxNQUFNQyxZQUFZLENBQUNSLE1BQUQsRUFBU1MsTUFBVCxL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LHVCQUFTVixRQUFRVSxLQUFSLElBQWlCLEdBSEU7QUFJNUJ2QiwyQkFBWWEsUUFBUWIsU0FBUixJQUFxQjtBQUpMLGVBQWYsQ0FBZjtBQU1BLG9CQUFNbUIsY0FBYyxNQUFNWixVQUFVUixNQUFWLEVBQW1CYyxRQUFRTyxNQUFSLElBQWtCLE1BQXJDLENBQTFCO0FBQ0EscUJBQU9sQixRQUFRaUIsV0FBUixDQUFQO0FBQ0QsYUFURCxDQVNFLE9BQU9kLEdBQVAsRUFBWTtBQUNaLHFCQUFPRixPQUFPRSxHQUFQLENBQVA7QUFDRDtBQUNILGVBQUssS0FBTDtBQUNBO0FBQ0UsZ0JBQUk7QUFDRixvQkFBTU4sU0FBU0gsU0FBU2dCLElBQVQsRUFBZTtBQUM1QlMseUJBQVMsSUFEbUI7QUFFNUJDLHNCQUFNLElBRnNCO0FBRzVCQyx1QkFBU1YsUUFBUVUsS0FBUixJQUFpQixHQUhFO0FBSTVCdkIsMkJBQVlhLFFBQVFiLFNBQVIsSUFBcUI7QUFKTCxlQUFmLENBQWY7QUFNQSxvQkFBTW1CLGNBQWMsTUFBTVosVUFBVVIsTUFBVixFQUFtQmMsUUFBUU8sTUFBUixJQUFrQixNQUFyQyxDQUExQjtBQUNBLHFCQUFPbEIsUUFBUWlCLFdBQVIsQ0FBUDtBQUNELGFBVEQsQ0FTRSxPQUFPZCxHQUFQLEVBQVk7QUFDWixxQkFBT0YsT0FBT0UsR0FBUCxDQUFQO0FBQ0Q7QUFuQ0w7QUFxQ0Q7QUFDRixLQTlFRDtBQStFRCxHQWhGTSxDQUFQO0FBaUZELENBbEZEOztBQW9GQW1CLE9BQU9DLE9BQVAsR0FBaUJkLEdBQWpCIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuY29uc3QgY28gPSByZXF1aXJlKFwiY29cIik7XG5jb25zdCBtaW1lID0gcmVxdWlyZShcIm1pbWVcIik7XG5jb25zdCBjc3ZQYXJzZSA9IHJlcXVpcmUoXCJjc3YtcGFyc2UvbGliL3N5bmNcIik7XG5jb25zdCBjc3ZTdHJpbmdpZnkgPSByZXF1aXJlKFwiY3N2LXN0cmluZ2lmeVwiKTtcblxuY29uc3QgdHJhbnNmb3JtVG9DU1YgPSAocGFyc2VkLCBkZWxpbWl0ZXIpID0+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjc3ZTdHJpbmdpZnkocGFyc2VkLCB7IGhlYWRlcjogdHJ1ZSwgZGVsaW1pdGVyOiBkZWxpbWl0ZXIgfSwgKGVyciwgY3N2KSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICAgIHJlc29sdmUoY3N2KTtcbiAgICB9KTtcbiAgfSk7XG59O1xuXG5jb25zdCB0cmFuc2Zvcm0gPSAocGFyc2VkLCBmb3JtYXQpID0+IHtcbiAgcmV0dXJuIGNvKGZ1bmN0aW9uKigpIHtcbiAgICBzd2l0Y2ggKGZvcm1hdCkge1xuICAgICAgY2FzZSBcImpzb25cIjpcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHBhcnNlZCk7XG4gICAgICBjYXNlIFwidHN2XCI6XG4gICAgICAgIHJldHVybiB5aWVsZCB0cmFuc2Zvcm1Ub0NTVihwYXJzZWQsIFwiXFx0XCIpO1xuICAgICAgY2FzZSBcImNzdlwiOlxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHlpZWxkIHRyYW5zZm9ybVRvQ1NWKHBhcnNlZCwgXCIsXCIpO1xuICAgIH1cbiAgfSk7XG59O1xuXG5jb25zdCB0ZGYgPSAoZGF0YSwgb3B0aW9ucywgaXNGaWxlKSA9PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY28oZnVuY3Rpb24qKCkge1xuICAgICAgaWYgKGlzRmlsZSkge1xuICAgICAgICBjb25zdCBmaWxlID0gZnMucmVhZEZpbGVTeW5jKGRhdGEsIFwiVVRGOFwiKTtcbiAgICAgICAgc3dpdGNoIChtaW1lLmxvb2t1cChkYXRhKSkge1xuICAgICAgICAgIGNhc2UgXCJhcHBsaWNhdGlvbi9qc29uXCI6XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKGZpbGUpO1xuICAgICAgICAgICAgICBjb25zdCB0cmFuc2Zvcm1lZCA9IHlpZWxkIHRyYW5zZm9ybShwYXJzZWQsIG9wdGlvbnMub3V0cHV0KTtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUodHJhbnNmb3JtZWQpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBjYXNlIFwidGV4dC9jc3ZcIjpcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IGNzdlBhcnNlKGZpbGUsIHtcbiAgICAgICAgICAgICAgICBjb2x1bW5zOiB0cnVlLFxuICAgICAgICAgICAgICAgIHRyaW06IHRydWUsXG4gICAgICAgICAgICAgICAgcXVvdGU6ICAob3B0aW9ucy5xdW90ZSB8fCAnXCInKSxcbiAgICAgICAgICAgICAgICBkZWxpbWl0ZXI6IChvcHRpb25zLmRlbGltaXRlciB8fCBcIixcIilcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIGNvbnN0IHRyYW5zZm9ybWVkID0geWllbGQgdHJhbnNmb3JtKHBhcnNlZCwgKG9wdGlvbnMub3V0cHV0IHx8IFwianNvblwiKSk7XG4gICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHRyYW5zZm9ybWVkKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgY2FzZSBcInRleHQvdGFiLXNlcGFyYXRlZC12YWx1ZXNcIjpcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IGNzdlBhcnNlKGZpbGUsIHtcbiAgICAgICAgICAgICAgICBjb2x1bW5zOiB0cnVlLFxuICAgICAgICAgICAgICAgIHRyaW06IHRydWUsXG4gICAgICAgICAgICAgICAgcXVvdGU6ICAob3B0aW9ucy5xdW90ZSB8fCAnXCInKSxcbiAgICAgICAgICAgICAgICBkZWxpbWl0ZXI6IChvcHRpb25zLmRlbGltaXRlciB8fCBcIlxcdFwiKVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgY29uc3QgdHJhbnNmb3JtZWQgPSB5aWVsZCB0cmFuc2Zvcm0ocGFyc2VkLCAob3B0aW9ucy5vdXRwdXQgfHwgXCJqc29uXCIpKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUodHJhbnNmb3JtZWQpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3dpdGNoIChvcHRpb25zLmZvcm1hdCkge1xuICAgICAgICAgIGNhc2UgXCJqc29uXCI6XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKGRhdGEpO1xuICAgICAgICAgICAgICBjb25zdCB0cmFuc2Zvcm1lZCA9IHlpZWxkIHRyYW5zZm9ybShwYXJzZWQsIG9wdGlvbnMub3V0cHV0KTtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUodHJhbnNmb3JtZWQpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBjYXNlIFwidHN2XCI6XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBjc3ZQYXJzZShkYXRhLCB7XG4gICAgICAgICAgICAgICAgY29sdW1uczogdHJ1ZSxcbiAgICAgICAgICAgICAgICB0cmltOiB0cnVlLFxuICAgICAgICAgICAgICAgIHF1b3RlOiAgKG9wdGlvbnMucXVvdGUgfHwgJ1wiJyksXG4gICAgICAgICAgICAgICAgZGVsaW1pdGVyOiAob3B0aW9ucy5kZWxpbWl0ZXIgfHwgXCJcXHRcIilcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIGNvbnN0IHRyYW5zZm9ybWVkID0geWllbGQgdHJhbnNmb3JtKHBhcnNlZCwgKG9wdGlvbnMub3V0cHV0IHx8IFwianNvblwiKSk7XG4gICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHRyYW5zZm9ybWVkKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgY2FzZSBcImNzdlwiOlxuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBjc3ZQYXJzZShkYXRhLCB7XG4gICAgICAgICAgICAgICAgY29sdW1uczogdHJ1ZSxcbiAgICAgICAgICAgICAgICB0cmltOiB0cnVlLFxuICAgICAgICAgICAgICAgIHF1b3RlOiAgKG9wdGlvbnMucXVvdGUgfHwgJ1wiJyksXG4gICAgICAgICAgICAgICAgZGVsaW1pdGVyOiAob3B0aW9ucy5kZWxpbWl0ZXIgfHwgXCIsXCIpXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBjb25zdCB0cmFuc2Zvcm1lZCA9IHlpZWxkIHRyYW5zZm9ybShwYXJzZWQsIChvcHRpb25zLm91dHB1dCB8fCBcImpzb25cIikpO1xuICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSh0cmFuc2Zvcm1lZCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSB0ZGY7XG4iXX0=